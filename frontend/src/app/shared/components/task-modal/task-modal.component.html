<p-dialog [(visible)]="visible" [modal]="true" [draggable]="false" [resizable]="false"
  [style]="{ width: isNormalUser && isEditMode ? '400px' : '600px', maxHeight: '90vh' }"
  [contentStyle]="{ 'max-height': 'calc(90vh - 120px)', 'overflow-y': 'auto' }" (onHide)="closeModal()">
  <ng-template pTemplate="header">
    <h3 class="text-xl font-bold text-gray-800">{{ modalTitle }}</h3>
  </ng-template>

  <form [formGroup]="taskForm" (ngSubmit)="onSubmit()" class="space-y-4">
    <!-- VISTA NORMAL USER EN MODO EDICIÓN: Solo estado -->
    @if (isNormalUser && isEditMode) {
    <div class="space-y-4">
      <!-- Información de la tarea (solo lectura) -->
      <div class="bg-gray-50 rounded-lg p-4 space-y-2">
        <h4 class="font-semibold text-gray-800">{{ task?.titulo }}</h4>
        <p class="text-sm text-gray-500">{{ task?.proyecto }}</p>
      </div>

      <!-- Estado (único campo editable) -->
      <div class="flex flex-col gap-2">
        <label for="estado" class="text-sm font-semibold text-gray-700">Cambiar Estado</label>
        <p-select id="estado" formControlName="estado_id" [options]="estados" optionLabel="nombre" optionValue="id"
          placeholder="Selecciona estado" styleClass="w-full" appendTo="body"></p-select>
      </div>
    </div>
    } @else {
    <!-- VISTA ADMIN/PM: Todos los campos -->
    <!-- Proyecto -->
    <div class="flex flex-col gap-2">
      <label for="proyecto" class="text-sm font-semibold text-gray-700">Proyecto <span
          class="text-red-500">*</span></label>
      <p-select id="proyecto" formControlName="proyecto_id" [options]="proyectos" optionLabel="nombre" optionValue="id"
        placeholder="Selecciona un proyecto" styleClass="w-full" appendTo="body"></p-select>
      @if (getErrorMessage('proyecto_id')) {
      <small class="text-red-500">{{ getErrorMessage('proyecto_id') }}</small>
      }
    </div>

    <!-- Título -->
    <div class="flex flex-col gap-2">
      <label for="titulo" class="text-sm font-semibold text-gray-700">Título <span class="text-red-500">*</span></label>
      <input pInputText id="titulo" formControlName="titulo" placeholder="Ingresa el título de la tarea"
        class="w-full" />
      @if (getErrorMessage('titulo')) {
      <small class="text-red-500">{{ getErrorMessage('titulo') }}</small>
      }
    </div>

    <!-- Descripción -->
    <div class="flex flex-col gap-2">
      <label for="descripcion" class="text-sm font-semibold text-gray-700">Descripción</label>
      <textarea pTextarea id="descripcion" formControlName="descripcion" rows="3"
        placeholder="Describe la tarea (opcional)" class="w-full"></textarea>
    </div>

    <!-- Fila: Prioridad y Estado -->
    <div class="grid grid-cols-2 gap-4">
      <!-- Prioridad -->
      <div class="flex flex-col gap-2">
        <label for="prioridad" class="text-sm font-semibold text-gray-700">Prioridad <span
            class="text-red-500">*</span></label>
        <p-select id="prioridad" formControlName="prioridad_id" [options]="prioridades" optionLabel="nombre"
          optionValue="id" placeholder="Selecciona prioridad" styleClass="w-full" appendTo="body"></p-select>
        @if (getErrorMessage('prioridad_id')) {
        <small class="text-red-500">{{ getErrorMessage('prioridad_id') }}</small>
        }
      </div>

      <!-- Estado -->
      <div class="flex flex-col gap-2">
        <label for="estado" class="text-sm font-semibold text-gray-700">Estado</label>
        <p-select id="estado" formControlName="estado_id" [options]="estados" optionLabel="nombre" optionValue="id"
          placeholder="Selecciona estado" styleClass="w-full" appendTo="body"></p-select>
      </div>
    </div>

    <!-- Fila: Asignado a y Fecha de Vencimiento -->
    <div class="grid gap-4" [ngClass]="usuarios.length > 0 ? 'grid-cols-2' : 'grid-cols-1'">
      <!-- Asignado a (solo si hay usuarios cargados - Admin/PM) -->
      @if (usuarios.length > 0) {
      <div class="flex flex-col gap-2">
        <label for="asignado" class="text-sm font-semibold text-gray-700">Asignar a</label>
        <p-select id="asignado" formControlName="usuario_asignado" [options]="usuarios" optionLabel="usuario_nombre"
          optionValue="usuario_id" placeholder="Sin asignar" styleClass="w-full" [showClear]="true"
          appendTo="body"></p-select>
      </div>
      }

      <!-- Fecha de Vencimiento -->
      <div class="flex flex-col gap-2">
        <label for="fecha_limite" class="text-sm font-semibold text-gray-700">Vencimiento</label>
        <p-datepicker id="fecha_limite" formControlName="fecha_limite" [showTime]="true" [showIcon]="true"
          [minDate]="minDate" placeholder="Selecciona fecha" dateFormat="dd/mm/yy" hourFormat="24" styleClass="w-full"
          appendTo="body" [showButtonBar]="true"></p-datepicker>
        @if (getErrorMessage('fecha_limite')) {
        <small class="text-red-500">{{ getErrorMessage('fecha_limite') }}</small>
        }
      </div>
    </div>
    }
  </form>

  <ng-template pTemplate="footer">
    <div class="flex justify-between gap-3">
      <div>
        <!-- Solo mostrar botón eliminar para Admin/PM en modo edición -->
        @if (isEditMode && !isNormalUser) {
        <button pButton label="Eliminar" icon="pi pi-trash" class="p-button-danger" (click)="handleDelete()"
          [disabled]="isLoading()"></button>
        }
      </div>
      <div class="flex gap-3">
        <button pButton label="Cancelar" class="p-button-text" (click)="closeModal()"></button>
        <button pButton [label]="isNormalUser && isEditMode ? 'Guardar' : (isEditMode ? 'Actualizar' : 'Crear')"
          class="p-button-primary" (click)="onSubmit()" [disabled]="taskForm.invalid" [loading]="isLoading()"></button>
      </div>
    </div>
  </ng-template>
</p-dialog>