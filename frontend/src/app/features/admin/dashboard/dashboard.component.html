<div class="dashboard bg-gradient-to-b from-gray-50 to-white min-h-screen">
  <!-- Loading State -->
  @if (tasksLoading()) {
  <div class="flex justify-center items-center py-16">
    <i class="pi pi-spin pi-spinner text-5xl text-blue-600"></i>
  </div>
  }

  <!-- Error State -->
  @if (errorMessage() && !tasksLoading()) {
  <div class="max-w-2xl mx-auto mt-8">
    <div class="bg-white rounded-2xl shadow-sm border border-red-100 p-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div
            class="w-12 h-12 bg-gradient-to-br from-red-50 to-red-100 rounded-2xl flex items-center justify-center"
          >
            <i class="pi pi-exclamation-triangle text-2xl text-red-600"></i>
          </div>
          <div>
            <h3 class="font-semibold text-red-900 text-lg mb-1">Error</h3>
            <p class="text-red-600">{{ errorMessage() }}</p>
          </div>
        </div>
        <button
          pButton
          label="Reintentar"
          icon="pi pi-refresh"
          class="p-button-danger bg-red-600 hover:bg-red-700 border-0 rounded-xl px-6 py-3 font-medium transition-all duration-200"
          (click)="refresh()"
        ></button>
      </div>
    </div>
  </div>
  }

  <!-- Main Content -->
  @if (!tasksLoading()) {
  <div class="flex gap-8 p-8">
    <!-- Kanban Board -->
    <div class="flex-1">
      <!-- Header -->
      <div class="mb-10 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
        <div class="flex flex-col lg:flex-row lg:items-center gap-6">
          <!-- Stats -->
          <div class="flex items-center gap-6">
            <div class="flex items-center gap-2">
              <span class="text-sm font-medium text-gray-500">Total Proyectos</span>
              <span class="text-2xl font-semibold text-gray-900">{{ totalProyectos() }}</span>
            </div>

            <div class="h-8 w-px bg-gray-200"></div>

            <div class="flex items-center gap-2">
              <span class="text-sm font-medium text-gray-500">Total Tareas</span>
              <span class="text-2xl font-semibold text-gray-900">{{ totalTareas() }}</span>
            </div>

            <div class="h-8 w-px bg-gray-200"></div>

            <div class="flex items-center gap-2">
              <span class="text-sm font-medium text-gray-500">Completadas</span>
              <span class="text-2xl font-semibold text-gray-900">{{ tareasCompletadas() }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Kanban Board -->
      <div class="mb-12 flex items-center justify-between">
        <h2 class="text-4xl font-semibold text-gray-900 tracking-tight">Tareas</h2>
        <button
          pButton
          label="Nueva Tarea"
          icon="pi pi-plus"
          class="p-button-primary bg-blue-600 hover:bg-blue-700 border-0 rounded-xl font-medium transition-all duration-200 shadow-sm hover:shadow-md"
          (click)="openCreateTaskModal()"
        ></button>
      </div>

      @if (tasksByEstado().length > 0) {
      <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6">
        @for (column of tasksByEstado(); track column.estado.estado_id) {
        <div class="flex flex-col bg-gray-50 rounded-2xl p-4 min-h-[500px]">
          <!-- Column Header -->
          <div class="mb-4 pb-4 border-b border-gray-200">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold text-gray-900 text-lg">{{ column.estado.nombre }}</h3>
              <span class="bg-gray-200 text-gray-700 text-xs font-medium px-2.5 py-1 rounded-full">
                {{ column.tasks.length }}
              </span>
            </div>
          </div>

          <!-- Dropzone -->
          <div
            class="flex-1 flex flex-col gap-3 min-h-[400px] p-2 rounded-xl transition-colors duration-200"
            [class.bg-blue-50]="isDraggingOver === column.estado.estado_id"
            (dragover)="onDragOver($event, column.estado.estado_id)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event, column.estado.estado_id)"
          >
            @if (column.tasks.length > 0) { @for (task of column.tasks; track task.id) {
            <div
              draggable="true"
              (dragstart)="onDragStart($event, task)"
              (dragend)="onDragEnd($event)"
              class="cursor-move hover:scale-[1.02] transition-transform duration-200"
            >
              <app-task-card
                [task]="task"
                (onEdit)="openEditTaskModal($event)"
                (onClick)="openDetailModal($event)"
              ></app-task-card>
            </div>
            } } @else {
            <div class="flex-1 flex items-center justify-center text-gray-400 text-sm">
              <div class="text-center">
                <i class="pi pi-inbox text-3xl mb-2"></i>
                <p>Sin tareas</p>
              </div>
            </div>
            }
          </div>
        </div>
        }
      </div>
      } @else {
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-16 text-center">
        <i class="pi pi-inbox text-7xl text-gray-300 mb-6"></i>
        <p class="text-gray-500 text-lg">No hay tareas disponibles</p>
      </div>
      }
    </div>

    <!-- Right Sidebar -->
    <!-- Funcionalidad extra si es que me da tiempo a implementar-->
  </div>
  }
</div>

<!-- Modal de Tarea -->
<app-task-modal
  [visible]="modalVisible()"
  (visibleChange)="modalVisible.set($event)"
  [task]="selectedTask()"
  [proyectos]="proyectos()"
  [estados]="estados()"
  [prioridades]="prioridades()"
  [usuarios]="usuarios()"
  [userRolId]="1"
  (onSave)="handleSaveTask($event)"
  (onCancel)="handleCancelModal()"
  (onDelete)="handleDeleteTask($event)"
></app-task-modal>

<app-task-detail-modal
  [visible]="detailModalVisible()"
  (visibleChange)="detailModalVisible.set(!!$event)"
  [task]="selectedTaskForDetail()"
  (onEdit)="openEditTaskModal($event); detailModalVisible.set(false)"
  (onClose)="detailModalVisible.set(false)"
>
</app-task-detail-modal>

<!-- Toast para notificaciones -->
<p-toast></p-toast>

<!-- ConfirmDialog para confirmaciones -->
<p-confirmDialog></p-confirmDialog>
